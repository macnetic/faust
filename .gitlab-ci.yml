variables:
    # variables defining where to find the FAµST external data
    # used by package build scripts
    # Warning: DURL is the base url without the filename
    DURL: "https://gitlab.inria.fr/faustgrp/gforge_files/-/raw/master/"
    DFILE: "faust_data-2.6.0.zip"
    JOB_PYTHON: "python3" # if set again in job, it hides this one (precedence: https://docs.gitlab.com/13.6/ee/ci/variables/#priority-of-environment-variables)
    WIN_PY_VER: '3.9' # default python version used to build python wrapper on windows (for both whl package and nsis .exe)
    NIX_PY_VER: '3.9' # default python version used to build python wrapper for "unix" system packages (pkg/macos, rpm/deb/linux)

.ctest_template: &ctest_script
    script:
        - ctest -O ctest.log -S ./CDashConfScript.cmake -j4

stages:
    - test
    - pkg
    - pkg_test
    - pkg_pub
    - gitlab_pages

ctest:
    <<: *ctest_script
    variables: {SLOW_TESTS: "OFF", BUILD_MULTITHREAD: "ON"} # the CDashConfScript is able to retrieve OpenMP_gomp_LIBRARY and OpenMP_INC_DIR from environment (it's necessary on macOS, so the runner's env. must be configured)
    script:
        - if git log --oneline -n 1 --name-status | grep -E '\s+(src/|misc/test/src/C++)'; then ctest -O ctest.log -S ./CDashConfScript.cmake -j4; else echo 'nothing new to test in C++ code'; fi # C++ tests are executed only if something was modified in C++ lib or C++ tests
    except:
        - schedules
        - tags
    stage: test
    tags:
        - linux

ctest_python:
    <<: *ctest_script
    variables: {BUILD_WRAPPER_PYTHON: "ON", SLOW_TESTS: "OFF", DONT_PYPLOT_FAUST_TIME: "ON", NOCPPTESTS: "ON", NOPY2: "ON", BUILD_MULTITHREAD: "ON"} #, GIT_STRATEGY: none}
    except:
        - schedules
        - tags
    stage: test
    allow_failure: false
    tags:
        - linux

ctest_matlab:
    <<: *ctest_script
    variables: {BUILD_WRAPPER_MATLAB: "ON", SLOW_TESTS: "OFF", NOCPPTESTS: "ON", BUILD_MULTITHREAD: "OFF"} # MT OFF because of macOS complicated way to enable OpenMP (but packages are OMP enabled)
    except:
        - schedules
        - tags
    stage: test
    tags:
        - matlab

.ctest_nightly: &ctest_nightly_script
    <<: *ctest_script
    variables: {BUILD_WRAPPER_MATLAB: "ON", BUILD_WRAPPER_PYTHON: "ON", SLOW_TESTS: "ON", DONT_PYPLOT_FAUST_TIME: "ON", NOPY2: "ON", BUILD_MULTITHREAD: "ON"}
    only:
        - schedules

ctest_nightly_linux:
    <<: *ctest_nightly_script
    tags:
        - linux
        - matlab

ctest_nightly_macos:
    <<: *ctest_nightly_script
    variables: {BUILD_WRAPPER_MATLAB: "ON", BUILD_WRAPPER_PYTHON: "ON", SLOW_TESTS: "ON", DONT_PYPLOT_FAUST_TIME: "ON", NOPY2: "ON", BUILD_MULTITHREAD: "OFF"} # set mt to OFF because MacOS is kind of tricky to configure with OpenMP
    tags:
        - macos

.ctest_nightly_win10:
    <<: *ctest_script
    only:
        - schedules
    tags:
        - win10

pkg_macos:
    stage: pkg
    script:
        - export PYTHON_PATH=$(which python$NIX_PY_VER)
        - SHA_START=$(echo $CI_COMMIT_SHA | sed -e 's/^\(.\{8\}\).*/\1/')
        - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
        - 'cmake -DOpenMP_gomp_LIBRARY=/opt/local/lib/libomp/libgomp.dylib -DBUILD_WRAPPER_PYTHON=ON -DBUILD_DOCUMENTATION=ON -DCPACK_PACKAGE_VERSION=$SHA_START -DCMAKE_INSTALL_PREFIX=/opt/local/faust-$SHA_START -DBUILD_TESTING=OFF -DREMOTE_DATA_URL="$DURL" -DREMOTE_DATA_FILE="$DFILE" -DEXPERIMENTAL_PKG=ON -DBUILD_MULTITHREAD=ON -DNOPY2=ON -DCMAKE_CXX_COMPILER=/opt/local/bin/clang++-mp-8.0 ..'
        - make LANG=en_GB.UTF-8
        # to compile matlab wrappers use matlab libiomp5 but backup the clang lib first
        - sudo mv /opt/local/lib/libomp/libomp.dylib /opt/local/lib/libomp/libomp.dylib.bak
        - sudo cp /opt/local/lib/libomp/libiomp5.dylib /opt/local/lib/libomp/libomp.dylib
        - cmake -DBUILD_WRAPPER_MATLAB=ON ..
        - make LANG=en_GB.UTF-8
        # restore clang libomp
        - sudo cp /opt/local/lib/libomp/libomp.dylib /opt/local/lib/libomp/libiomp5.dylib
        - sudo mv /opt/local/lib/libomp/libomp.dylib.bak /opt/local/lib/libomp/libomp.dylib
        # ensure the linking of libomp to the python wrapper shared lib is right (not overridden by matlab libomp)
        - sudo install_name_tool -change @rpath/libiomp5.dylib /opt/local/lib/libomp/libomp.dylib wrapper/python/_FaustCorePy.cpython-*-darwin.so
        - sudo make install LANG=en_GB.UTF-8
          #- 'sudo hdiutil create -volname Faust-$SHA_START-MatlabR2016a-Py2.7 -srcfolder /opt/local/faust-$SHA_START -ov -format UDRW faust-$SHA_START'
        - sudo pkgbuild --identifier fr.inria.faust --version $SHA_START --root /opt/local/faust-$SHA_START --install-location /opt/local/faust-$SHA_START --scripts . ./faust-$SHA_START.pkg
        - for FILE in $(find /usr/local/lib ! -iname "libmatio*" -maxdepth 1 -mindepth 1); do filter_list+="--filter $(basename $FILE) "; done;
        - sudo pkgbuild --identifier fr.inria.faust.matio --version 1.5.12 --root /usr/local/lib $filter_list --install-location /usr/local/lib ./matio-bin-1.5.12.pkg
        - sudo pkgbuild --identifier fr.inria.faust.openmp --version 367070 --root /opt/local/lib/libomp --install-location /opt/local/lib/libomp ./libomp-367070.pkg
        - productbuild --synthesize --package ./matio-bin-1.5.12.pkg --package libomp-367070.pkg --package faust-$SHA_START.pkg ./distribution.plist
        - sed -e 's/\(.*pkg-ref id=.fr.inria.faust".*\)/\1<title>FAµST '$SHA_START'<\/title><license file="licenses.html"\/><readme file="installer_readme.html"\/>/' distribution.plist > tmp.plist; mv tmp.plist distribution.plist
        - productbuild --distribution ./distribution.plist --package-path matio-bin-1.5.12.pkg --package-path libomp-367070.pkg --package-path faust-$SHA_START.pkg --resources doc ./faust-matio-omp-$SHA_START.pkg
        - mv -f faust-matio-omp-$SHA_START.pkg faust-$SHA_START.pkg
        # - if [[ -d $MACOS_PKG_STORE_PATH ]]; then sudo mv faust-$SHA_START.dmg faust-$SHA_START.pkg $MACOS_PKG_STORE_PATH; fi
        #- if [[ -d $MACOS_PKG_STORE_PATH ]]; then sudo cp faust-$SHA_START.dmg faust-$SHA_START.pkg $MACOS_PKG_STORE_PATH; fi
        - if [[ -d $MACOS_PKG_STORE_PATH ]]; then sudo cp faust-$SHA_START.pkg $MACOS_PKG_STORE_PATH; fi
    artifacts:
        paths:
            - build/faust-${CI_COMMIT_SHA:0:8}.pkg
              #- build/faust-${CI_COMMIT_SHA:0:8}.dmg
        expire_in: '1 week'
    tags:
        - macos
    except:
        - schedules
        - tags
    needs:
      - job: ctest_python
      - job: ctest_matlab

.win_build_gpu_mod: &win_build_gpu_mod
    before_script:
#        - move gpu_mod gpu_mod2 #del /Q /S gpu_mod\* # & rmdir gpu_mod & mkdir gpu_mod
#        - mkdir gpu_mod
#        - git submodule sync --recursive
#        - git submodule update --init --recursive
        - cd gpu_mod
        - if NOT EXIST build (mkdir build) else (rmdir /S /Q build & mkdir build)
        - cd build
        - cmake -G "Visual Studio 14 Win64" ..
          #- cmake -G "MinGW Makefiles" -DCMAKE_CUDA_COMPILER="E:/NVIDIA GPU Computing Toolkit/CUDA/v9.2/bin/nvcc.exe" .. #-DCUDA_HOST_COMPILER="E:/TDM-GCC-64/bin/g++.exe" ..
        - cmake --build . --config %BUILD_CONFIG%
        - move %BUILD_CONFIG%\gm.dll .
        - cd ..\..

pkg_win:
    stage: pkg
    variables: {BUILD_CONFIG: "Debug", GIT_SUBMODULE_STRATEGY: recursive}
    <<: *win_build_gpu_mod
    script:
        - 'set SHA_START=%CI_COMMIT_SHA:~0,8%'
        - if NOT EXIST build (mkdir build) else (rmdir /S /Q build & mkdir build)
        - cd build
          #- 'cmake -G "MinGW Makefiles" -DBUILD_WRAPPER_MATLAB=ON -DBUILD_WRAPPER_PYTHON=ON -DSLOW_TESTS=OFF -DCPACK_PACKAGE_VERSION=%SHA_START% -DBUILD_DOCUMENTATION=ON -DEXCLUDE_FAUST_LIB_INSTALL=ON -DCMAKE_INSTALL_PREFIX=win_pkg_build -DBUILD_TESTING=OFF -DAPI_DOC_BASE_URL="file:///C:/Program Files/Faust/doc/" -DREMOTE_DATA_URL="%DURL%" -DREMOTE_DATA_FILE="%DFILE%" -DEXPERIMENTAL_PKG=ON -DUSE_GPU_MOD=ON -DCMAKE_PREFIX_PATH=../gpu_mod ..'
          #- make
        - 'cmake -G "Visual Studio 14 Win64" -DBUILD_WRAPPER_MATLAB=ON -DBUILD_WRAPPER_PYTHON=ON -DSLOW_TESTS=OFF -DCPACK_PACKAGE_VERSION=%SHA_START% -DBUILD_DOCUMENTATION=ON -DEXCLUDE_FAUST_LIB_INSTALL=ON -DCMAKE_INSTALL_PREFIX=win_pkg_build -DBUILD_TESTING=OFF -DUSE_MATIO_STATIC_LIBS=ON -DMATIO_STATIC_LIB_PATH="C:/Users/faust/Downloads/matio-1.5.13/visual_studio/x64/Release/libmatio.lib" -DZ_STATIC_LIB_PATH="C:/Users/faust/Downloads/zlib-1.2.11/contrib/vstudio/vc14/x64/ZlibStatDebug/zlibstat.lib" -DHDF5_STATIC_LIB_PATH="C:/Users/faust/Downloads/hdf5-1.10.3/build/bin/Release/libhdf5.lib" -DAPI_DOC_BASE_URL="file:///C:/Program Files/Faust/doc/" -DREMOTE_DATA_URL="%DURL%" -DREMOTE_DATA_FILE="%DFILE%" -DEXPERIMENTAL_PKG=ON -DUSE_GPU_MOD=ON -DCMAKE_PREFIX_PATH=../gpu_mod -DPYTHON_ENCODING=windows-1252 -DBUILD_MULTITHREAD=ON ..'
        - cmake --build . --config Release # Debug is avoided because of debug symbols missing for at least one library (inconsistency of config mode across libraries)
        - makensis faust.nsi
    artifacts:
        paths:
            - build/faust-%CI_COMMIT_SHA:~0,8%-amd64.exe
        expire_in: '1 week'
    tags:
        - win10
          #- win7
    except:
        - schedules
        - tags
    needs:
        - job: ctest_python
        - job: ctest_matlab

.build_gpu_mod: &build_gpu_mod
    before_script:
        - cd gpu_mod; if [[ ! -d build ]]; then mkdir build; fi; cd build
        - cmake -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-9.2 -DCMAKE_CUDA_COMPILER=/usr/local/cuda-9.2/bin/nvcc ..; make
        - cd ../..

pkg_linux:
    <<: *build_gpu_mod
    stage: pkg
    variables: {GIT_SUBMODULE_STRATEGY: recursive} # for checking out gpu_mod
    script:
        # build faust
        - SHA_START=$(echo $CI_COMMIT_SHA | sed -e 's/^\(.\{8\}\).*/\1/')
        - export PYTHON_PATH=$(which python$NIX_PY_VER)
        - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
        - 'cmake -DBUILD_WRAPPER_PYTHON=ON -DBUILD_WRAPPER_MATLAB=ON -DBUILD_DOCUMENTATION=ON -DCMAKE_INSTALL_PREFIX=/opt/local/faust-$SHA_START -DCPACK_PACKAGE_FILE_NAME=faust-$SHA_START -DCPACK_PACKAGE_VERSION=$SHA_START -DBUILD_TESTING=OFF -DREMOTE_DATA_URL="$DURL" -DREMOTE_DATA_FILE="$DFILE" -DEXPERIMENTAL_PKG=ON -DNOPY2=ON -DUSE_GPU_MOD=ON -DCMAKE_PREFIX_PATH=$PWD/../gpu_mod ..'
        - make
          # generate package via cpack
        - cpack -G RPM -C CPackConfig.cmake
        - cpack -G DEB -C CPackConfig.cmake
        - 'cp faust-$SHA_START* $HOME'
    artifacts:
        paths:
            - build/faust-${CI_COMMIT_SHA:0:8}-x86_64.deb
            - build/faust-${CI_COMMIT_SHA:0:8}-x86_64.rpm
        expire_in: '1 week'
    tags:
        - linux
        - matlab
        - tux_packager
    except:
        - schedules
        - tags
    needs:
        - job: ctest_python
        - job: ctest_matlab

          # jobs triggered by git tag can force cpack to use the tag name as version but it's not necessary for MacOSX (not using cpack for that sys.)
          #it's done for linux packages

pkg_macos_release:
    stage: pkg
    script:
        - export PYTHON_PATH=$(which python$NIX_PY_VER)
        - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
        - 'cmake -DOpenMP_gomp_LIBRARY=/opt/local/lib/libomp/libgomp.dylib -DBUILD_WRAPPER_PYTHON=ON -DBUILD_DOCUMENTATION=ON -DCMAKE_INSTALL_PREFIX=/opt/local/faust -DCPACK_PACKAGE_VERSION=$CI_COMMIT_TAG -DCMAKE_BUILD_TYPE=Release -DEXCLUDE_FAUST_LIB_INSTALL=ON -DBUILD_TESTING=OFF -DREMOTE_DATA_URL="$DURL" -DREMOTE_DATA_FILE="$DFILE" -DBUILD_MULTITHREAD=ON -DNOPY2=ON -DCMAKE_CXX_COMPILER=/opt/local/bin/clang++-mp-8.0 ..'
        - make LANG=en_GB.UTF-8
        # to compile matlab wrappers use matlab libiomp5 but backup the clang lib first
        - sudo mv /opt/local/lib/libomp/libomp.dylib /opt/local/lib/libomp/libomp.dylib.bak
        - sudo cp /opt/local/lib/libomp/libiomp5.dylib /opt/local/lib/libomp/libomp.dylib
        - cmake -DBUILD_WRAPPER_MATLAB=ON ..
        - make LANG=en_GB.UTF-8
        # restore clang libomp
        - sudo cp /opt/local/lib/libomp/libomp.dylib /opt/local/lib/libomp/libiomp5.dylib
        - sudo mv /opt/local/lib/libomp/libomp.dylib.bak /opt/local/lib/libomp/libomp.dylib
          # ensure the linking of libomp to the python wrapper shared lib is right (not overridden by matlab libomp)
        - otool -L wrapper/python/_FaustCorePy.cpython-*-darwin.so
        - sudo install_name_tool -change @rpath/libiomp5.dylib /opt/local/lib/libomp/libomp.dylib wrapper/python/_FaustCorePy.cpython-*-darwin.so
        - otool -L wrapper/python/_FaustCorePy.cpython-*-darwin.so
        - sudo rm -Rf /opt/local/faust # install dir
        - 'sudo make install LANG=en_GB.UTF-8'
        # ensure libomp path also in install path
        - sudo install_name_tool -change @rpath/libiomp5.dylib /opt/local/lib/libomp/libomp.dylib /opt/local/faust/python/_FaustCorePy.cpython-*-darwin.so
        - otool -L wrapper/python/_FaustCorePy.cpython-*-darwin.so
        - 'sudo hdiutil create -volname Faust-$CI_COMMIT_TAG-MatlabR2016a-Py2.7 -srcfolder /opt/local/faust -ov -format UDRW faust-$CI_COMMIT_TAG'
        - sudo pkgbuild --identifier fr.inria.faust --version $CI_COMMIT_TAG --root /opt/local/faust --install-location /opt/local/faust --scripts . ./faust-$CI_COMMIT_TAG.pkg
        - for FILE in $(find /usr/local/lib ! -iname "libmatio*" -maxdepth 1 -mindepth 1); do filter_list+="--filter $(basename $FILE) "; done;
        - sudo pkgbuild --identifier fr.inria.faust.matio --version 1.5.12 --root /usr/local/lib $filter_list --install-location /usr/local/lib ./matio-bin-1.5.12.pkg
        - sudo pkgbuild --identifier fr.inria.faust.openmp --version 367070 --root /opt/local/lib/libomp --install-location /opt/local/lib/libomp ./libomp-367070.pkg
        - productbuild --synthesize --package ./matio-bin-1.5.12.pkg --package libomp-367070.pkg --package faust-$CI_COMMIT_TAG.pkg ./distribution.plist
        - sed -e 's/\(.*pkg-ref id=.fr.inria.faust".*\)/\1<title>FAµST '$CI_COMMIT_TAG'<\/title><license file="licenses.html"\/><readme file="installer_readme.html"\/>/' distribution.plist > tmp.plist; mv tmp.plist distribution.plist
        - productbuild --distribution ./distribution.plist --package-path matio-bin-1.5.12.pkg --package-path libomp-367070.pkg --package-path faust-$CI_COMMIT_TAG.pkg --resources doc ./faust-matio-omp-$CI_COMMIT_TAG.pkg
        - mv -f ./faust-matio-omp-$CI_COMMIT_TAG.pkg ./faust-$CI_COMMIT_TAG.pkg
          #- if [[ -d $MACOS_PKG_STORE_PATH ]]; then sudo cp faust-$CI_COMMIT_TAG.dmg faust-$CI_COMMIT_TAG.pkg $MACOS_PKG_STORE_PATH; fi
        - if [[ -d $MACOS_PKG_STORE_PATH ]]; then sudo cp faust-$CI_COMMIT_TAG.pkg $MACOS_PKG_STORE_PATH; fi
    artifacts:
        paths:
            - build/faust-${CI_COMMIT_TAG}.pkg
              #- build/faust-${CI_COMMIT_TAG}.dmg
        expire_in: '50 yrs'
    tags:
        - macos
    only:
        - tags

pkg_win_release:
    variables: {BUILD_CONFIG: "Release", GIT_SUBMODULE_STRATEGY: recursive}
    stage: pkg
    <<: *win_build_gpu_mod
    script:
        - if NOT EXIST build (mkdir build) else (rmdir /S /Q build & mkdir build)
        - cd build
          #- 'cmake -G "MinGW Makefiles" -DBUILD_WRAPPER_MATLAB=ON -DBUILD_WRAPPER_PYTHON=ON -DSLOW_TESTS=OFF -DCPACK_PACKAGE_VERSION=%CI_COMMIT_TAG% -DBUILD_DOCUMENTATION=ON -DEXCLUDE_FAUST_LIB_INSTALL=ON -DCMAKE_INSTALL_PREFIX=win_pkg_build -DBUILD_TESTING=OFF -DAPI_DOC_BASE_URL="file:///C:/Program Files/Faust/doc/" -DREMOTE_DATA_URL="%DURL%" -DREMOTE_DATA_FILE="%DFILE%" -DUSE_GPU_MOD=ON -DCMAKE_PREFIX_PATH=../gpu_mod ..'
          # - make
        - 'cmake -G "Visual Studio 14 Win64" -DBUILD_WRAPPER_MATLAB=ON -DBUILD_WRAPPER_PYTHON=ON -DSLOW_TESTS=OFF -DCPACK_PACKAGE_VERSION=%CI_COMMIT_TAG% -DBUILD_DOCUMENTATION=ON -DEXCLUDE_FAUST_LIB_INSTALL=ON -DCMAKE_INSTALL_PREFIX=win_pkg_build -DBUILD_TESTING=OFF -DUSE_MATIO_STATIC_LIBS=ON -DMATIO_STATIC_LIB_PATH="C:/Users/faust/Downloads/matio-1.5.13/visual_studio/x64/Release/libmatio.lib" -DZ_STATIC_LIB_PATH="C:/Users/faust/Downloads/zlib-1.2.11/contrib/vstudio/vc14/x64/ZlibStatDebug/zlibstat.lib" -DHDF5_STATIC_LIB_PATH="C:/Users/faust/Downloads/hdf5-1.10.3/build/bin/Release/libhdf5.lib" -DAPI_DOC_BASE_URL="file:///C:/Program Files/Faust/doc/" -DREMOTE_DATA_URL="%DURL%" -DREMOTE_DATA_FILE="%DFILE%" -DEXPERIMENTAL_PKG=OFF -DUSE_GPU_MOD=ON -DCMAKE_PREFIX_PATH=../gpu_mod -DPYTHON_ENCODING=windows-1252 -DBUILD_MULTITHREAD=ON ..'
        - cmake --build . --config Release
        - makensis faust.nsi
    artifacts:
        paths:
            - build/faust-%CI_COMMIT_TAG%-amd64.exe
        expire_in: '50 yrs'
    tags:
        #- win7
        - win10
    only:
        - tags

pkg_linux_release:
    <<: *build_gpu_mod
    stage: pkg
    script:
        - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
        - export PYTHON_PATH=$(which python$NIX_PY_VER)
        - 'cmake -DBUILD_WRAPPER_PYTHON=ON -DBUILD_WRAPPER_MATLAB=ON -DBUILD_DOCUMENTATION=ON -DCMAKE_INSTALL_PREFIX=/opt/local/faust -DCPACK_PACKAGE_FILE_NAME=faust-$CI_COMMIT_TAG -DCPACK_PACKAGE_VERSION=$CI_COMMIT_TAG -DEXCLUDE_FAUST_LIB_INSTALL=ON  -DBUILD_TESTING=OFF -DREMOTE_DATA_URL="$DURL" -DREMOTE_DATA_FILE="$DFILE" -DNOPY2=ON -DUSE_GPU_MOD=ON -DCMAKE_PREFIX_PATH=$PWD/../gpu_mod ..'
        - make
        - cpack -G RPM -C CPackConfig.cmake
        - cpack -G DEB -C CPackConfig.cmake
        - 'cp faust-$CI_COMMIT_TAG*rpm faust-$CI_COMMIT_TAG*.deb $HOME'
    artifacts:
        paths:
            - build/faust-$CI_COMMIT_TAG-x86_64.deb
            - build/faust-$CI_COMMIT_TAG-x86_64.rpm
        expire_in: '50 yrs'
    tags:
        - linux
        - matlab
        - tux_packager
    only:
        - tags


pkg_linux_release_static:
    stage: pkg
    script:
        - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
        - export PYTHON_PATH=$(which python$NIX_PY_VER)
        - 'cmake -DBUILD_WRAPPER_PYTHON=ON -DBUILD_WRAPPER_MATLAB=ON -DBUILD_DOCUMENTATION=ON -DCMAKE_INSTALL_PREFIX=/opt/local/faust -DCPACK_PACKAGE_FILE_NAME=faust-$CI_COMMIT_TAG-static -DCPACK_PACKAGE_VERSION=$CI_COMMIT_TAG -DEXCLUDE_FAUST_LIB_INSTALL=ON -DUSE_MATIO_STATIC_LIBS=ON -DMATIO_STATIC_LIB_PATH=/opt/local/matio-1.5.7/src/.libs/libmatio.a -DZ_STATIC_LIB_PATH=/opt/local/zlib-1.2.11/libz.a -DHDF5_STATIC_LIB_PATH=/opt/local/hdf5-1.8.18/src/.libs/libhdf5.a -DBUILD_TESTING=OFF -DREMOTE_DATA_URL="$DURL" -DREMOTE_DATA_FILE="$DFILE" -DBUILD_MULTITHREAD=ON -DNOPY2=ON -DUSE_GPU_MOD=ON -DCMAKE_PREFIX_PATH=$PWD/../gpu_mod ..'
        - make
        - cpack -G RPM -C CPackConfig.cmake
        - cpack -G DEB -C CPackConfig.cmake
        - 'cp faust-$CI_COMMIT_TAG*rpm faust-$CI_COMMIT_TAG*.deb $HOME'
    artifacts:
        paths:
            - build/faust-$CI_COMMIT_TAG-static-x86_64.deb
            - build/faust-$CI_COMMIT_TAG-static-x86_64.rpm
        expire_in: '50 yrs'
    tags:
        - linux
        - matlab
        - tux_packager
    only:
        - tags

pages:
    stage: gitlab_pages
    script:
        - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
        - 'cmake -DBUILD_WRAPPER_PYTHON=ON -DBUILD_WRAPPER_MATLAB=ON -DBUILD_DOCUMENTATION=ON -DCMAKE_INSTALL_PREFIX=/opt/local/faust -DCPACK_PACKAGE_FILE_NAME=faust-$CI_COMMIT_TAG -DCPACK_PACKAGE_VERSION=$CI_COMMIT_TAG -DEXCLUDE_FAUST_LIB_INSTALL=ON  -DINCLUDE_ALL_SYS_INSTALL_INSTRUCS=ON ..'
        - make doc
        - make doc_exclu_class_filtering
        - mkdir -p ../public/last-doc
        - cp -Rf doc/html ../public/last-doc/
        - mkdir -p ../public/packages
        - ../gen_doc/gen_pkg_dl_page.sh $CI_COMMIT_TAG # download.html generated
        - mv download.html ../public/packages/
        - mv *.pkg *.rpm *.deb *.exe ../public/packages/
    needs:
      - job: pkg_macos_release
        artifacts: true
      - job: pkg_win_release
        artifacts: true
      - job: pkg_linux_release
        artifacts: true
      - job: pkg_linux_release_static
        artifacts: true
      - job: test_linux_pkg_release
      - job: test_macos_pkg_release
    artifacts:
        paths:
            - public/
    tags:
        - linux
        - matlab
        - pages
    only:
        - tags


.pkg_purepy: &pkg_purepy
    script:
        - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
        - 'cmake -DBUILD_WRAPPER_PYTHON=ON -DBUILD_WRAPPER_MATLAB=OFF -DBUILD_DOCUMENTATION=ON -DCPACK_PACKAGE_VERSION=$VERSION -DCMAKE_INSTALL_PREFIX=/opt/local/faust-$SHA_START -DBUILD_TESTING=OFF -DEXCLUDE_FAUST_LIB_INSTALL=ON -DUSE_MATIO_STATIC_LIBS=ON -DMATIO_STATIC_LIB_PATH=$MATIO_STATIC_LIB_PATH -DZ_STATIC_LIB_PATH=$Z_STATIC_LIB_PATH -DHDF5_STATIC_LIB_PATH=$HDF5_STATIC_LIB_PATH -DREMOTE_DATA_URL="$DURL" -DREMOTE_DATA_FILE="$DFILE" -DEXPERIMENTAL_PKG=$EXPERIMENTAL_PKG -DFAUST_TORCH=$FAUST_TORCH -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" -DNOPY2=$NOPY2 -DBUILD_MULTITHREAD=$BUILD_MULTITHREAD -DUSE_GPU_MOD=$USE_GPU_MOD -DEXPERIMENTAL_PKG=$EXPERIMENTAL_PKG -DFAUST_TORCH=$FAUST_TORCH ..'
        - make
        - cd wrapper/python
        - $JOB_PYTHON setup.py bdist_wheel
        - $JOB_PYTHON setup.py bdist_egg
        - if [[ "$NOPY2" != "ON" ]]; then python2 setup.py bdist_wheel; fi
        - if [[ "$NOPY2" != "ON" ]]; then python2 setup.py bdist_egg; fi
    artifacts:
        paths:
            - build/wrapper/python/dist
    except:
        - schedules

.pkg_purepy_rev:
    extends: .pkg_purepy
    stage: pkg
    before_script:
        - VERSION=$(echo $CI_COMMIT_SHA | sed -e 's/^\(.\{8\}\).*/\1/')
        - if [[ -n "$USE_GPU_MOD" ]]; then GPU_MOD_SHA=$(git submodule foreach git log --oneline -n1 | sed -e 's/ .*//' | tail -1); fi
        - echo GPU_MOD_SHA=$GPU_MOD_SHA
        - if [[ -n "$USE_GPU_MOD" ]]; then cd gpu_mod; if [[ ! -d build ]]; then mkdir build; fi; cd build; fi
          # don't build the lib if already installed
        - if [[ -n "$USE_GPU_MOD" ]]; then cmake -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-9.2 -DCMAKE_CUDA_COMPILER=/usr/local/cuda-9.2/bin/nvcc ..;L=$HOME"/libgm-$GPU_MOD_SHA.so"; echo LIB=$L; if [[ -r "$L" ]]; then cp "$L" ./libgm.so; else make; cp ./libgm.so "$L";fi;fi
        - if [[ -n "$USE_GPU_MOD" ]]; then cd ../..; fi
    artifacts:
        expire_in: '1 week'
    except:
        - schedules
        - tags

pkg_macos_purepy_rev:
    extends: .pkg_purepy_rev
    variables: {MATIO_STATIC_LIB_PATH: "/usr/local/lib/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/lib/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/lib/libhdf5.a", EXPERIMENTAL_PKG: "ON", BUILD_MULTITHREAD: "ON", NOPY2: "ON"}
    before_script:
      - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
      - cmake -DCMAKE_CXX_COMPILER=/opt/local/bin/clang++-mp-8.0 ..
      - cd ..
    tags:
        - macos
    needs:
        - job: ctest_python


pkg_linux_purepy_rev:
    extends: .pkg_purepy_rev
    variables: {GIT_SUBMODULE_STRATEGY: recursive, MATIO_STATIC_LIB_PATH: "/opt/local/matio-1.5.7/src/.libs/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/zlib-1.2.11/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/hdf5-1.8.18/src/.libs/libhdf5.a", BUILD_MULTITHREAD: "ON", NOPY2: "ON", USE_GPU_MOD: "ON", CMAKE_PREFIX_PATH: "../gpu_mod", EXPERIMENTAL_PKG: "ON"}
    tags:
        - linux
        - tux_packager
    needs:
        - job: ctest_python

.pkg_purepy_release:
    stage: pkg
    extends: .pkg_purepy
    before_script:
        - VERSION=$CI_COMMIT_TAG
        - if [[ -n "$USE_GPU_MOD" ]]; then GPU_MOD_SHA=$(git submodule foreach git log --oneline -n1 | sed -e 's/ .*//' | tail -1); fi
        - echo GPU_MOD_SHA=$GPU_MOD_SHA
        - if [[ -n "$USE_GPU_MOD" ]]; then cd gpu_mod; if [[ ! -d build ]]; then mkdir build; fi; cd build; fi
          # don't build the lib if already installed
        - if [[ -n "$USE_GPU_MOD" ]]; then cmake -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-9.2 -DCMAKE_CUDA_COMPILER=/usr/local/cuda-9.2/bin/nvcc ..;L=$HOME"/libgm-$GPU_MOD_SHA.so"; echo LIB=$L; if [[ -r "$L" ]]; then cp "$L" ./libgm.so; else make; cp ./libgm.so "$L";fi;fi
        - if [[ -n "$USE_GPU_MOD" ]]; then cd ../..; fi
    artifacts:
        expire_in: '50 yrs'
    except:
        - schedules
    only:
        - tags

pkg_macos_purepy_release:
    extends: .pkg_purepy_release
    variables: {MATIO_STATIC_LIB_PATH: "/usr/local/lib/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/lib/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/lib/libhdf5.a", BUILD_MULTITHREAD: "ON", FAUST_TORCH: "OFF", EXPERIMENTAL_PKG: "OFF", NOPY2: "ON"}
    before_script:
      - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
      - cmake -DCMAKE_CXX_COMPILER=/opt/local/bin/clang++-mp-8.0 ..
      - cd ..
    tags:
        - macos

pkg_macos_purepy_release_extra_pyver:
    extends: .pkg_purepy_release
    variables: {MATIO_STATIC_LIB_PATH: "/usr/local/lib/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/lib/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/lib/libhdf5.a", BUILD_MULTITHREAD: "ON", FAUST_TORCH: "OFF", EXPERIMENTAL_PKG: "OFF", NOPY2: "ON", PYTHON_PATH: '/opt/local/bin/python3.9', JOB_PYTHON: 'python3.9'}
    before_script:
      - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
      - cmake -DCMAKE_CXX_COMPILER=/opt/local/bin/clang++-mp-8.0 ..
      - cd ..
    tags:
        - macos

pkg_macos_purepy_release_torch_linked:
    extends: pkg_macos_purepy_release
    variables: {GIT_SUBMODULE_STRATEGY: recursive, MATIO_STATIC_LIB_PATH: "/usr/local/lib/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/lib/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/lib/libhdf5.a", FAUST_TORCH: "ON", CMAKE_PREFIX_PATH: "/opt/local/libtorch/share/cmake/Torch", BUILD_MULTITHREAD: "ON", EXPERIMENTAL_PKG: "OFF", NOPY2: "ON"}
    before_script:
      - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
      - cmake -DCMAKE_CXX_COMPILER=/opt/local/bin/clang++-mp-8.0 ..
      - cd ..

pkg_linux_purepy_release:
    extends: .pkg_purepy_release
    variables: {GIT_SUBMODULE_STRATEGY: recursive, MATIO_STATIC_LIB_PATH: "/opt/local/matio-1.5.7/src/.libs/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/zlib-1.2.11/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/hdf5-1.8.18/src/.libs/libhdf5.a", BUILD_MULTITHREAD: "ON", NOPY2: "ON", USE_GPU_MOD: "ON", CMAKE_PREFIX_PATH: "../gpu_mod", FAUST_TORCH: "OFF", EXPERIMENTAL_PKG: "OFF"}
    tags:
        - linux
        - tux_packager

pkg_linux_purepy_release_extra_pyver:
    extends: .pkg_purepy_release
    variables: {GIT_SUBMODULE_STRATEGY: recursive, MATIO_STATIC_LIB_PATH: "/opt/local/matio-1.5.7/src/.libs/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/zlib-1.2.11/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/hdf5-1.8.18/src/.libs/libhdf5.a", BUILD_MULTITHREAD: "ON", NOPY2: "ON", USE_GPU_MOD: "ON", CMAKE_PREFIX_PATH: "../gpu_mod", FAUST_TORCH: "OFF", EXPERIMENTAL_PKG: "OFF", PYTHON_PATH: '/usr/local/bin/python3.9', JOB_PYTHON: 'python3.9'}
    tags:
        - linux
        - tux_packager


pkg_linux_purepy_release_torch_linked:
    extends: pkg_linux_purepy_release
    variables: {GIT_SUBMODULE_STRATEGY: recursive, MATIO_STATIC_LIB_PATH: "/opt/local/matio-1.5.7/src/.libs/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/zlib-1.2.11/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/hdf5-1.8.18/src/.libs/libhdf5.a", BUILD_MULTITHREAD: "ON", NOPY2: "ON", FAUST_TORCH: "ON", USE_GPU_MOD: "ON", CMAKE_PREFIX_PATH: "/opt/local/libtorch/share/cmake/Torch;../gpu_mod", EXPERIMENTAL_PKG: "OFF"}

.pkg_purepy_release_rasp:
    stage: pkg
    variables: {MATIO_STATIC_LIB_PATH: "/opt/local/libmatio.a", Z_STATIC_LIB_PATH: "/opt/local/libz.a", HDF5_STATIC_LIB_PATH: "/opt/local/libhdf5.a"}
    script:
        - if [[ ! -d 'build' ]]; then  mkdir build;fi; cd build
        - 'cmake -DBUILD_WRAPPER_PYTHON=ON -DBUILD_WRAPPER_MATLAB=OFF -DBUILD_DOCUMENTATION=ON -DCPACK_PACKAGE_VERSION=$CI_COMMIT_TAG -DCMAKE_INSTALL_PREFIX=/opt/local/faust-$SHA_START -DBUILD_TESTING=OFF -DEXCLUDE_FAUST_LIB_INSTALL=ON -DUSE_MATIO_STATIC_LIBS=ON -DMATIO_STATIC_LIB_PATH=$MATIO_STATIC_LIB_PATH -DZ_STATIC_LIB_PATH=$Z_STATIC_LIB_PATH -DHDF5_STATIC_LIB_PATH=$HDF5_STATIC_LIB_PATH -DREMOTE_DATA_URL="$DURL" -DREMOTE_DATA_FILE="$DFILE" -DEXPERIMENTAL_PKG=OFF -DNOPY2=ON -DBUILD_MULTITHREAD=ON ..'
        - ln -s /usr/bin/clang gcc
        - export PATH=$PWD:$PATH
        - make
        - cd wrapper/python
        - python3 setup.py bdist_wheel
    artifacts:
        paths:
            - build/wrapper/python/dist
    except:
        - schedules
    only:
        - tags
    tags:
        - arm

########### pip binary packages for windows

.pkg_win_purepy: &pkg_win_purepy
    stage: pkg
    script:
        - cd gpu_mod
        - if NOT EXIST build (mkdir build) else (rmdir /S /Q build & mkdir build)
        - cd build
        - cmake -G "Visual Studio 14 Win64" ..
        - cmake --build . --config %BUILD_CONFIG%
        - move %BUILD_CONFIG%\gm.dll .
        - cd ..\..
        - if NOT EXIST build (mkdir build) else (rmdir /S /Q build & mkdir build)
        - cd build
        - 'cmake -G "Visual Studio 14 2015" -DBUILD_WRAPPER_MATLAB=OFF -DBUILD_WRAPPER_PYTHON=ON -DSLOW_TESTS=OFF -DCPACK_PACKAGE_VERSION=%VERSION% -DCMAKE_INSTALL_PREFIX=win_pkg_build -DBUILD_TESTING=OFF  -DUSE_MATIO_STATIC_LIBS=ON -DMATIO_STATIC_LIB_PATH="C:/Users/faust/Downloads/matio-1.5.13/visual_studio/x64/Release/libmatio.lib" -DZ_STATIC_LIB_PATH="C:/Users/faust/Downloads/zlib-1.2.11/contrib/vstudio/vc14/x64/ZlibStatDebug/zlibstat.lib" -DHDF5_STATIC_LIB_PATH="C:/Users/faust/Downloads/hdf5-1.10.3/build/bin/Release/libhdf5.lib" -DREMOTE_DATA_URL="%DURL%" -DREMOTE_DATA_FILE="%DFILE%" -DEXPERIMENTAL_PKG=%EXPERIMENTAL_PKG% -DUSE_GPU_MOD=ON  -DCMAKE_PREFIX_PATH=../gpu_mod -DBUILD_MULTITHREAD=ON ..'
        #- make
        - cmake --build . --target FAUST
        - cd wrapper/python
          # only python3 for windows
          #- 'start %PYTHON2_PATH% setup.py bdist_wheel'
          #- 'start %PYTHON2_PATH% setup.py bdist_egg'
          #- 'call "%PYTHON_PATH%" setup.py bdist_wheel'
          #- 'call "%PYTHON_PATH%" setup.py bdist_egg'
        - py -%WIN_PY_VER% setup.py bdist_wheel
        - py -%WIN_PY_VER% setup.py bdist_egg
    artifacts:
        paths:
            - build\wrapper\python\dist
    tags:
        - win10
    except:
        - schedules

pkg_win_purepy_rev:
    extends: .pkg_win_purepy
    variables: {BUILD_CONFIG: "Debug", GIT_SUBMODULE_STRATEGY: recursive}
    before_script:
        - 'set VERSION=%CI_COMMIT_SHA:~0,8%'
        - 'set EXPERIMENTAL_PKG=ON'
    artifacts:
        expire_in: '1 week'
    except:
        - schedules
        - tags
    needs:
        - job: ctest_python

pkg_win_purepy_release:
    extends: .pkg_win_purepy
    variables: {BUILD_CONFIG: "Release", GIT_SUBMODULE_STRATEGY: recursive, EXPERIMENTAL_PKG: "OFF"}
    before_script:
        - 'set VERSION=%CI_COMMIT_TAG%'
    artifacts:
        expire_in: '50 yrs'
    only:
        - tags

pkg_win_purepy_release_extra_pyver:
    extends: .pkg_win_purepy
    variables: {BUILD_CONFIG: "Release", GIT_SUBMODULE_STRATEGY: recursive, EXPERIMENTAL_PKG: "OFF", WIN_PY_VER: '3.7'}
    before_script:
        - 'set VERSION=%CI_COMMIT_TAG%'
    artifacts:
        expire_in: '50 yrs'
    only:
        - tags

test_macos_pkg_release:
  stage: pkg_test
  needs:
    - job: pkg_macos_release
      artifacts: true
  script:
    - sudo installer -pkg build/faust-$CI_COMMIT_TAG.pkg -target /
    - matlab -nojvm -nodisplay -r "disp(matfaust.version());disp(full(matfaust.rand(5,5))); exit;" | tee /tmp/faust && grep $CI_COMMIT_TAG /tmp/faust
    - python$NIX_PY_VER -c "import pyfaust; print(pyfaust.version()); print(pyfaust.rand(5,5).toarray());"
    - python$NIX_PY_VER -c "import pyfaust.tests; pyfaust.tests.run_tests('cpu', 'real')"
  only:
    - tags
  tags:
    - macos
    - macos_pkg_tester

test_linux_pkg_release:
  stage: pkg_test
  needs:
    - job: pkg_linux_release
      artifacts: true
    - job: pkg_linux_release_static
      artifacts: true
  script:
    - sudo rpm -i --nodeps build/faust-$CI_COMMIT_TAG-x86_64.rpm
    - matlab -nojvm -nodisplay -r "disp(matfaust.version());disp(full(matfaust.rand(5,5))); exit;" | tee /tmp/faust && grep $CI_COMMIT_TAG /tmp/faust
    - python$NIX_PY_VER -c "import pyfaust; print(pyfaust.version()); print(pyfaust.rand(5,5).toarray());"
    - python$NIX_PY_VER -c "import pyfaust.tests; pyfaust.tests.run_tests('cpu', 'real')"
    - sudo rpm -e faust
    - sudo rpm -i --nodeps build/faust-$CI_COMMIT_TAG-static-x86_64.rpm
    - matlab -nojvm -nodisplay -r "disp(matfaust.version());disp(full(matfaust.rand(5,5))); exit;" | tee /tmp/faust && grep $CI_COMMIT_TAG /tmp/faust
    - python$NIX_PY_VER -c "import pyfaust; print(pyfaust.version()); print(pyfaust.rand(5,5).toarray());"
    - python$NIX_PY_VER -c "import pyfaust.tests; pyfaust.tests.run_tests('cpu', 'real')"
    - sudo rpm -e faust
  only:
    - tags
  tags:
    - linux
    - matlab

# the windows NSIS installer test is disabled because "call .exe" is hanging down indefinitely
.test_win_pkg_release:
  stage: pkg_test
  needs:
    - job: pkg_win_release
      artifacts: true
  script:
    - cd build
    - dir
      #- call 'build\faust-%CI_COMMIT_TAG%-amd64.exe' /S
    - python -c "import os; os.system(\"faust-%CI_COMMIT_TAG%-amd64.exe /S\")"
    - timeout 20
    - dir 'C:\Program Files\Faust\'
      # the matlab test is disabled because the Windows VMs are not able to access the license server (VPN issue)
      #- matlab -nojvm -r "disp(matfaust.version());disp(full(matfaust.rand(5,5)));F=matfaust.rand(5,5);save(F, 'F.mat');exit;"
      #- python -c "from os.path import exists;from time import sleep; sleep(15); exit(0);if(exists('F.mat')) else exit(1)"
    - python -c "import pyfaust; print(pyfaust.version()); print(pyfaust.rand(5,5).toarray());"
    - python -c "import pyfaust.tests; pyfaust.tests.run_tests('cpu', 'real')"
    - cd "C:\Program Files\Faust"
      #- call 'uninstall.exe' /S
    - python -c "import os; os.system('uninstall.exe /S')"
  only:
    - tags
  tags:
    - win10

.test_unix_purepy_pkg:
  stage: pkg_test
  script:
    - $JOB_PYTHON -m venv test_pyfaust-$CI_COMMIT_TAG
    - source test_pyfaust-$CI_COMMIT_TAG/bin/activate
    - PYVER=$($JOB_PYTHON --version | awk '{print $2}' | sed -e 's/\.//g;s/\(..\).*/\1/')
    - $JOB_PYTHON -m pip install --upgrade build/wrapper/python/dist/pyfaust-$CI_COMMIT_TAG-*$PYVER*.whl
    - $JOB_PYTHON -c "import pyfaust; print(pyfaust.version()); print(pyfaust.rand(5,5).toarray());"
    - $JOB_PYTHON -c "import pyfaust.tests; pyfaust.tests.run_tests('cpu', 'real')"
  only:
    - tags

test_macos_purepy_release:
  variables: {JOB_PYTHON: 'python3'}
  extends: .test_unix_purepy_pkg
  needs:
    - job: pkg_macos_purepy_release
      artifacts: true
  tags:
    - macos
    - macos_pkg_tester

test_macos_purepy_release_extra_pyver:
  variables: {JOB_PYTHON: 'python3.9'} # take care to keep this variable consistent with the version used in pkg_macos_purepy_release_extra_pyver
  extends: .test_unix_purepy_pkg
  needs:
    - job: pkg_macos_purepy_release_extra_pyver
      artifacts: true
  tags:
    - macos
    - macos_pkg_tester

test_nux_purepy_release:
  variables: {JOB_PYTHON: 'python3'}
  extends: .test_unix_purepy_pkg
  needs:
    - job: pkg_linux_purepy_release
      artifacts: true
  tags:
    - linux

test_nux_purepy_release_extra_pyver:
  variables: {JOB_PYTHON: 'python3.9'}
  extends: .test_unix_purepy_pkg
  needs:
    - job: pkg_linux_purepy_release_extra_pyver
      artifacts: true
  tags:
    - linux

test_win_purepy_pkg:
  variables: {JOB_PYTHON: 'py'}
  stage: pkg_test
  script:
    - 'cd build\wrapper\python\dist'
    - 'dir /B pyfaust*.whl > pkg_name.txt'
    - 'set /p PKG_NAME=<pkg_name.txt'
    - '%JOB_PYTHON% -%WIN_PY_VER% -m venv test_pyfaust-%CI_COMMIT_TAG%'
    - 'call test_pyfaust-%CI_COMMIT_TAG%\Scripts\activate'
    - python -m pip install %PKG_NAME%
    - python -c "import pyfaust; print(pyfaust.version()); print(pyfaust.rand(5,5).toarray());"
    - python -c "import pyfaust.tests; pyfaust.tests.run_tests(\"cpu\", \"real\")"
  needs:
    - job: pkg_win_purepy_release
      artifacts: true
  only:
    - tags
  tags:
    - win10

test_win_purepy_pkg_extra_pyver:
  extends: test_win_purepy_pkg
  variables: {JOB_PYTHON: 'py', WIN_PY_VER: '3.7'}
  needs:
    - job: pkg_win_purepy_release_extra_pyver
      artifacts: true

pypi_pub:
  stage: pkg_pub
  script:
    - python3 -m pip install --user twine
    - cd build/wrapper/python/dist/
    - find
    - NUX_WHLS=$(ls *linux*x86_64.whl)
    - for NUX_WHL in $NUX_WHLS; do mv $NUX_WHL ${NUX_WHL%-*}-manylinux1_x86_64.whl; done # proper format for pypi (just linux is not accepted)
    - TOKEN=$(echo $PYPI_TOKEN | base64 -d)
    - echo -e "__token__\n$TOKEN" | python3 -m twine upload *.whl
  needs:
    - job: pkg_macos_purepy_release
      artifacts: true
    - job: pkg_linux_purepy_release
      artifacts: true
    - job: pkg_linux_purepy_release_extra_pyver
      artifacts: true
    - job: pkg_win_purepy_release
      artifacts: true
    - job: pkg_win_purepy_release_extra_pyver
      artifacts: true
    - job: pkg_macos_purepy_release_extra_pyver
      artifacts: true
    - job: test_nux_purepy_release
    - job: test_nux_purepy_release_extra_pyver
    - job: test_win_purepy_pkg
    - job: test_macos_purepy_release
    - job: test_macos_purepy_release_extra_pyver
    - job: test_win_purepy_pkg_extra_pyver
    - job: test_linux_pkg_release # all the packages for this version must be OK to have a go on pypi upload
    - job: test_macos_pkg_release
  only:
    - tags
  tags:
    - linux

#pkg_upload:
#  stage: pkg_pub
#  script:
#        - misc/continuous_integration/upload_pkg.sh
#  needs:
#    - job: pkg_macos_release
#      artifacts: true
#    - job: pkg_win_release
#      artifacts: true
#    - job: pkg_linux_release
#      artifacts: true
#  only:
#    - tags
#  tags:
#    - linux
