#include "faust_constant.h"

#include "faust_MatBSR.h"
#include "faust_MatBSR_gpu.h"
#include "faust_cuda_device.h"
#include <cstdlib>
#include <cmath>
using namespace std;
using namespace Faust;

typedef @TEST_FPP@ FPP;

void test_gpu_ctor_and_tocpu()
{
	std::cout << "test_gpu_ctor_and_tocpu" << std::endl;
	auto nrows = 10;
	auto ncols = 15;
	auto bnrows = 5;
	auto bncols = 5;
	auto bnnz = 2;
	auto cpu_bsr_mat = Faust::MatBSR<double, Cpu>::randMat(nrows, ncols, bnrows, bncols, bnnz);
	Faust::MatBSR<double, Cpu> cpu_bsr_mat2;
	Faust::MatBSR<double, GPU2> gpu_bsr_mat(
			cpu_bsr_mat->getNbRow(),
			cpu_bsr_mat->getNbCol(),
			cpu_bsr_mat->getNbBlockRow(),
			cpu_bsr_mat->getNbBlockCol(),
			cpu_bsr_mat->getNBlocks(),
			cpu_bsr_mat->get_bdata(),
			cpu_bsr_mat->get_browptr(),
			cpu_bsr_mat->get_bcolinds());
	gpu_bsr_mat.tocpu(cpu_bsr_mat2);
	assert(cpu_bsr_mat->norm() == cpu_bsr_mat2.norm());
	MatDense<FPP, Cpu> diff_mat = cpu_bsr_mat->to_dense();
	diff_mat -= cpu_bsr_mat2.to_dense();
	assert(diff_mat.norm() < 1e-3);
	cout << "OK" << endl;
	delete cpu_bsr_mat;
}

void test_gpu_mul_dense()
{
	std::cout << "test_gpu_mul_dense" << std::endl;
	// gen a cpu random dense matrix
	MatDense<FPP, Cpu> *cpu_dmat = MatDense<FPP, Cpu>::randMat(15, 10);
	// convert it to gpu
	MatDense<FPP, GPU2> gpu_dmat(*cpu_dmat);
	// idem for bsr mats
	auto cpu_bmat = MatBSR<double, Cpu>::randMat(10, 15, 5, 5, 2);
	MatBSR<FPP, GPU2> gpu_bmat(*cpu_bmat);

	// multiply on cpu
	cpu_bmat->multiply(*cpu_dmat, 'N');
	gpu_bmat.multiply(gpu_dmat, 'N');

	MatDense<FPP, Cpu> diff_mat;
	gpu_dmat.tocpu(diff_mat);
	diff_mat -= *cpu_dmat;
	assert(diff_mat.norm() < 1e-3);
	delete cpu_bmat;
	delete cpu_dmat;
	std::cout << "OK" << std::endl;
}

int main()
{
	Faust::enable_gpu_mod();
	test_gpu_ctor_and_tocpu();
	test_gpu_mul_dense();
}


