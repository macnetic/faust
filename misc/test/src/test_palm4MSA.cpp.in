#include "faust_MatDense.h"
#include "faust_Params.h"
#include "faust_ParamsPalm.h"
#include "StoppingCriterion.h"
#include "faust_init_from_matio.h"
#include "faust_init_from_matio_mat.h"
#include "Palm4MSA.h"
#include "BlasHandleCPU.h"

#include <iostream>

// modif AL AL
//#include "faust_ConstraintInt.h"
//#include "faust_ConstraintFPP.h"

using namespace std;
typedef @TEST_FPP@ FPP;
/** \brief Run a test of Palm4MSA
 */
int main()
{
  Faust::MatDense<FPP,Cpu> data, init_facts1, init_facts2;

  char config_palm2_filename[] = "@FAUST_TESTDATA_SRC_DIR@/config_compared_palm2.mat";

  init_faust_mat_from_matio(data, config_palm2_filename, "data");
  init_faust_mat_from_matio(init_facts1, config_palm2_filename, "init_facts1");
  init_faust_mat_from_matio(init_facts2, config_palm2_filename, "init_facts2");

  int cons1_name, cons1_parameter, cons1_row, cons1_col;
  int cons2_name, cons2_row, cons2_col;
  FPP cons2_parameter;
  int nfacts, niter;
  bool update_way, verbose;
  double init_lambda;

  cons1_name = init_int_from_matio(config_palm2_filename, "cons1_name");
  cons1_parameter = init_int_from_matio(config_palm2_filename, "cons1_parameter");
  cons1_row = init_int_from_matio(config_palm2_filename, "cons1_row");
  cons1_col = init_int_from_matio(config_palm2_filename, "cons1_col");

  cons2_name = init_int_from_matio(config_palm2_filename, "cons2_name");
  cons2_parameter = (FPP) init_double_from_matio(config_palm2_filename, "cons2_parameter");
  cons2_row = init_int_from_matio(config_palm2_filename, "cons2_row");
  cons2_col = init_int_from_matio(config_palm2_filename, "cons2_col");


  init_lambda = (FPP) init_double_from_matio(config_palm2_filename, "init_lambda");
  nfacts = init_int_from_matio(config_palm2_filename, "nfacts");
  niter = init_int_from_matio(config_palm2_filename, "niter");

  update_way = init_bool_from_matio(config_palm2_filename, "update_way");
  verbose = init_bool_from_matio(config_palm2_filename, "verbose");

  // Creation du vecteur de contrainte
  const Faust::ConstraintInt<FPP,Cpu> cons1(static_cast<faust_constraint_name>(cons1_name), cons1_parameter, cons1_row, cons1_col);
  const Faust::ConstraintFPP<FPP,Cpu> cons2(static_cast<faust_constraint_name>(cons2_name), cons2_parameter, cons2_row, cons2_col);

  vector<const Faust::ConstraintGeneric<FPP,Cpu>*> cons;
  cons.push_back(&cons1);
  cons.push_back(&cons2);


  // Creation du vecteur de matrice init_fact;
  vector<Faust::MatDense<FPP,Cpu> > init_fact;
  init_fact.push_back(init_facts1);
  init_fact.push_back(init_facts2);

  // Creation du critere d'arret
  StoppingCriterion<FPP> crit(niter);

  Faust::ParamsPalm<FPP,Cpu> params(data, nfacts, cons, init_fact, crit, verbose, update_way, init_lambda);

  BlasHandle<Cpu> blas_handle;

  Palm4MSA<FPP,Cpu> palm2(params,blas_handle,true);

  palm2.next_step();


return 0;
}
